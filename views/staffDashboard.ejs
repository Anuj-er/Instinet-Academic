<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - InstiNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('./partials/header', {user: user}) %>
    
    <div class="dashboard-layout">
        <%- include('./partials/sidebar', {user: user}) %>
        
        <div class="dashboard-content">
            <!-- <% if (error) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <%= error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>
            <% if (success) { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <%= success %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %> -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">Staff Dashboard</h1>
                <!-- <div class="dashboard-actions">
                    <button class="btn btn-primary"><i class="fas fa-plus"></i> Add Content</button>
                </div> -->
            </div>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-book fa-2x"></i>
                    </div>
                    <div class="stat-details">
                        <h3><%= stats.totalCourses %></h3>
                        <p>Total Courses</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-graduate fa-2x"></i>
                    </div>
                    <div class="stat-details">
                        <h3><%= stats.totalStudents %></h3>
                        <p>Students</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-bullhorn fa-2x"></i>
                    </div>
                    <div class="stat-details">
                        <h3><%= stats.totalAnnouncements %></h3>
                        <p>Announcements</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                    <div class="stat-details">
                        <h3><%= students.length %></h3>
                        <p>Managed Students</p>
                    </div>
                </div>
            </div>
            
            <!-- Courses and Announcements Side by Side -->
            <div class="dashboard-grid-2col">
                <div id="courses-section" class="dashboard-section">
                    <div class="dashboard-section-header">
                        <h2 class="dashboard-section-title"><i class="fas fa-book"></i> My Courses</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="courseFilter">
                                <option value="all">All Courses</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="courses-list">
                        <% if (courses && courses.length > 0) { %>
                            <% courses.forEach(course => { %>
                                <div class="course-card-compact">
                                    <div class="course-card-header">
                                        <div class="course-icon-small"><i class="fas fa-book"></i></div>
                                        <div class="course-info">
                                            <h4><%= course.courseName %></h4>
                                            <p class="course-schedule">
                                                <i class="fas fa-code"></i> <%= course.code %> | <%= course.department %>
                                                <% if (course.schedule) { %>
                                                    <br><i class="fas fa-clock"></i> <%= course.schedule %>
                                                <% } %>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="course-card-footer">
                                        <span class="badge badge-success">Active</span>
                                        <% if (course.instructor) { %>
                                            <span class="student-count"><i class="fas fa-user"></i> <%= course.instructor %></span>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <p class="empty-state">No courses available.</p>
                        <% } %>
                    </div>
                </div>
                
                <div id="announcements-section" class="dashboard-section">
                    <div class="dashboard-section-header">
                        <h2 class="dashboard-section-title"><i class="fas fa-bullhorn"></i> Announcements</h2>
                        <div class="section-actions">
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createAnnouncementModal">
                                <i class="fas fa-plus"></i> New
                            </button>
                        </div>
                    </div>
                    
                    <div class="announcements-list">
                        <% if (announcements && announcements.length > 0) { %>
                            <% announcements.forEach(announcement => { %>
                                <div class="announcement-item">
                                    <div class="announcement-header">
                                        <h3 class="announcement-title"><%= announcement.title %></h3>
                                        <div class="announcement-meta">
                                            <span class="announcement-author">
                                                <i class="fas fa-user"></i> <%= announcement.createdBy ? `${announcement.createdBy.firstName} ${announcement.createdBy.lastName}` : 'Staff' %>
                                            </span>
                                            <span class="announcement-date">
                                                <i class="fas fa-calendar"></i> <%= new Date(announcement.createdAt).toLocaleDateString() %>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="announcement-content">
                                        <p><%= announcement.message %></p>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <p class="empty-state">No announcements at this time.</p>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Students Section -->
            <div id="students-section" class="dashboard-section">
                <div class="dashboard-section-header">
                    <h2 class="dashboard-section-title"><i class="fas fa-user-graduate"></i> All Students</h2>
                    <div class="section-actions">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="studentSearch" placeholder="Search students...">
                        </div>
                        <select class="filter-select" id="departmentFilter">
                            <option value="all">All Departments</option>
                            <option value="CS">Computer Science</option>
                            <option value="IT">Information Technology</option>
                            <option value="ECE">Electronics</option>
                        </select>
                    </div>
                </div>
                
                <div class="students-grid" id="studentsGrid">
                    <% students.forEach(student => { %>
                        <div class="student-card" data-department="<%= student.studentDetails?.department || 'N/A' %>">
                            <div class="student-avatar">
                                <%= student.firstName.charAt(0) %><%= student.lastName.charAt(0) %>
                            </div>
                            <div class="student-info">
                                <h4><%= student.firstName %> <%= student.lastName %></h4>
                                <p class="student-id"><i class="fas fa-id-badge"></i> <%= student.studentDetails?.enrollmentNumber || 'N/A' %></p>
                                <p class="student-dept"><i class="fas fa-building"></i> <%= student.studentDetails?.department || 'N/A' %></p>
                            </div>
                            <div class="student-courses">
                                <span class="courses-label"><i class="fas fa-book"></i> Courses (<%= student.courses.length %>)</span>
                                <div class="courses-dropdown">
                                    <% if (student.courses.length > 0) { %>
                                        <% student.courses.slice(0, 3).forEach(course => { %>
                                            <span class="course-tag"><%= course.courseName %></span>
                                        <% }); %>
                                        <% if (student.courses.length > 3) { %>
                                            <span class="course-tag-more">+<%= student.courses.length - 3 %> more</span>
                                        <% } %>
                                    <% } else { %>
                                        <span class="no-courses">No courses enrolled</span>
                                    <% } %>
                                </div>
                            </div>
                            <div class="student-actions">
                                <button class="btn-icon" title="View Profile"><i class="fas fa-eye"></i></button>
                                <button class="btn-icon" title="Send Message"><i class="fas fa-envelope"></i></button>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Announcement Modal -->
    <div class="modal fade" id="createAnnouncementModal" tabindex="-1" aria-labelledby="createAnnouncementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form action="/announcements/create" method="POST" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createAnnouncementModalLabel">New Announcement</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- <% if (error) { %>
                        <div class="alert alert-danger"><%= error %></div>
                    <% } %> -->
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" name="title" id="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="message" class="form-label">Message</label>
                        <textarea class="form-control" name="message" id="message" rows="4" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Create Announcement</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Socket.io Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('#createAnnouncementModal form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const title = document.getElementById('title').value.trim();
                const message = document.getElementById('message').value.trim();
                
                if (!title || !message) {
                    e.preventDefault();
                    alert('Please fill in all fields');
                    return;
                }
            });
        }
        
        // Student search functionality
        const studentSearch = document.getElementById('studentSearch');
        const departmentFilter = document.getElementById('departmentFilter');
        const studentCards = document.querySelectorAll('.student-card');
        
        function filterStudents() {
            const searchTerm = studentSearch.value.toLowerCase();
            const selectedDept = departmentFilter.value;
            
            studentCards.forEach(card => {
                const studentName = card.querySelector('h4').textContent.toLowerCase();
                const department = card.getAttribute('data-department');
                
                const matchesSearch = studentName.includes(searchTerm);
                const matchesDept = selectedDept === 'all' || department === selectedDept;
                
                if (matchesSearch && matchesDept) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        if (studentSearch) {
            studentSearch.addEventListener('input', filterStudents);
        }
        
        if (departmentFilter) {
            departmentFilter.addEventListener('change', filterStudents);
        }
        
        // Socket.io real-time announcements for staff dashboard
        if (typeof io !== 'undefined') {
            const socket = io();
            
            socket.on('newAnnouncement', (announcement) => {
                console.log('ðŸ”” New announcement received on staff dashboard:', announcement);
                
                // Prepend new announcement to the list
                const announcementsList = document.querySelector('.announcements-list');
                if (announcementsList) {
                    const firstP = announcementsList.querySelector('p.empty-state');
                    if (firstP) {
                        firstP.remove();
                    }
                    
                    const announcementItem = document.createElement('div');
                    announcementItem.className = 'announcement-item new-announcement';
                    announcementItem.style.animation = 'fadeIn 0.5s ease-out';
                    
                    const createdDate = new Date(announcement.createdAt).toLocaleDateString();
                    const creatorName = announcement.createdBy 
                        ? `${announcement.createdBy.firstName} ${announcement.createdBy.lastName}` 
                        : 'Staff';
                    
                    announcementItem.innerHTML = `
                        <div class="announcement-header">
                            <h3 class="announcement-title">${announcement.title}</h3>
                            <div class="announcement-meta">
                                <span class="announcement-author"><i class="fas fa-user"></i> ${creatorName}</span>
                                <span class="announcement-date"><i class="fas fa-calendar"></i> ${createdDate}</span>
                            </div>
                        </div>
                        <div class="announcement-content">
                            <p>${announcement.message}</p>
                        </div>
                    `;
                    
                    announcementsList.insertBefore(announcementItem, announcementsList.firstChild);
                    
                    // Remove highlight after 3 seconds
                    setTimeout(() => {
                        announcementItem.classList.remove('new-announcement');
                    }, 3000);
                }
            });
        }
    });
    </script>
</body>
</html>